# ---------------------------------------------------------------------------
# Licensed to the Apache Software Foundation (ASF) under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The ASF licenses this file to You under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License.  You may obtain a copy of the License at
#
#      http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
# ------------------------------------------------------------------------------
apiVersion: "camel.apache.org/v1alpha1"
kind: "Kamelet"
metadata:
  annotations:
    camel.apache.org/kamelet.support.level: "Stable"
    camel.apache.org/catalog.version: "main-SNAPSHOT"
    camel.apache.org/kamelet.icon: "data:image/svg+xml;base64,PHN2ZyBlbmFibGUtYmFja2dyb3VuZD0ibmV3IDAgMCAxNjE1IDE3ODMuNyIgdmlld0JveD0iMCAwIDE2MTUgMTc4My43IiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPjxwYXRoIGQ9Im04MDcuNSAxMzYzLjggNjc4LjMgMTYxLjV2LTEyNzAuNWwtNjc4LjMgMTYxLjV6IiBmaWxsPSIjMjA1Yjk3Ii8+PHBhdGggZD0ibTE0ODUuOCAyNTQuOCAxMjkuMiA2NC42djExNDEuM2wtMTI5LjIgNjQuNnptLTY3OC4zIDExMDktNjc4LjMgMTYxLjV2LTEyNzAuNWw2NzguMyAxNjEuNXoiIGZpbGw9IiM1MTkzY2UiLz48cGF0aCBkPSJtMTI5LjIgMjU0LjgtMTI5LjIgNjQuNnYxMTQxLjNsMTI5LjIgNjQuNnoiIGZpbGw9IiMyMDViOTciLz48cGF0aCBkPSJtOTc5LjggMTc4My43IDI1OC40LTEyOS4ydi0xNTI1LjNsLTI1OC40LTEyOS4yLTc5IDg0N3oiIGZpbGw9IiM1MTkzY2UiLz48cGF0aCBkPSJtNjM1LjIgMTc4My43LTI1OC40LTEyOS4ydi0xNTI1LjNsMjU4LjQtMTI5LjIgNzkgODQ3eiIgZmlsbD0iIzIwNWI5NyIvPjxwYXRoIGQ9Im02MzUuMiAwaDM0OC4xdjE3ODAuMWgtMzQ4LjF6IiBmaWxsPSIjMmU3M2I3Ii8+PC9zdmc+"
    camel.apache.org/provider: "Apache Software Foundation"
    camel.apache.org/kamelet.group: "AWS Redshift"
  labels:
    camel.apache.org/kamelet.type: "source"
  name: "aws-redshift-source"
  headers: {}
spec:
  definition:
    description: "Query data from an AWS RedShift Database."
    properties:
      serverName:
        description: "The server name for the data source."
        example: "localhost"
        title: "Server Name"
        type: "string"
      serverPort:
        default: 5439
        description: "The server port for the data source."
        title: "Server Port"
        type: "string"
      username:
        description: "The username to access a secured AWS RedShift Database."
        title: "Username"
        type: "string"
        x-descriptors:
         - "urn:camel:group:credentials"
      password:
        description: "The password to access a secured AWS RedShift Database."
        format: "password"
        title: "Password"
        type: "string"
        x-descriptors:
         - "urn:alm:descriptor:com.tectonic.ui:password"
         - "urn:camel:group:credentials"
      query:
        description: "The query to execute against the AWS RedShift Database."
        example: "INSERT INTO accounts (username,city) VALUES (:#username,:#city)"
        title: "Query"
        type: "string"
      databaseName:
        description: "The name of the AWS RedShift Database."
        title: "Database Name"
        type: "string"
      consumedQuery:
        description: "A query to run on a tuple consumed."
        example: "DELETE FROM accounts where user_id = :#user_id"
        title: "Consumed Query"
        type: "string"
      delay:
        default: 500
        description: "The number of milliseconds before the next poll from the AWS RedShift database."
        title: "Delay"
        type: "integer"
    required:
     - "serverName"
     - "username"
     - "password"
     - "query"
     - "databaseName"
    title: "AWS Redshift Source"
    type: "object"
  dependencies:
   - "camel:jackson"
   - "camel:kamelet"
   - "camel:sql"
   - "mvn:com.amazon.redshift:redshift-jdbc42:2.1.0.9"
   - "mvn:org.apache.commons:commons-dbcp2:2.9.0"
  template:
    beans:
     -
      name: "dsBean"
      type: "#class:org.apache.commons.dbcp2.BasicDataSource"
      property:
       -
        key: "username"
        value: "{{username}}"
       -
        key: "password"
        value: "{{password}}"
       -
        key: "url"
        value: "jdbc:redshift://{{serverName}}:{{serverPort}}/{{databaseName}}"
       -
        key: "driverClassName"
        value: "com.amazon.redshift.jdbc.Driver"
    from:
      uri: "sql:{{query}}"
      parameters:
        dataSource: "#bean:{{dsBean}}"
        onConsume: "{{?consumedQuery}}"
        delay: "{{delay}}"
      steps:
       -
        marshal:
          json:
            library: "Jackson"
       -
        to: "kamelet:sink"
  types:
    out:
      mediaType: "application/json"
